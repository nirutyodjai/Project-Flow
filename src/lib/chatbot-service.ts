/**
 * AI Chatbot Service - ‡∏£‡∏∞‡∏ö‡∏ö Chatbot ‡∏ä‡πà‡∏ß‡∏¢‡∏ï‡∏≠‡∏ö‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°
 */

export interface ChatMessage {
  id: string;
  role: 'user' | 'assistant' | 'system';
  content: string;
  timestamp: string;
  intent?: string;
  entities?: any;
}

export interface ChatContext {
  projectId?: string;
  projectName?: string;
  budget?: number;
  currentPage?: string;
}

/**
 * ‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡πÅ‡∏•‡∏∞‡∏ï‡∏≠‡∏ö‡∏Å‡∏•‡∏±‡∏ö
 */
export async function processChatMessage(
  message: string,
  context: ChatContext = {},
  history: ChatMessage[] = []
): Promise<ChatMessage> {
  const lowerMessage = message.toLowerCase();

  // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö Intent
  let response = '';
  let intent = 'general';

  // ‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Å‡∏±‡∏ö‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£
  if (lowerMessage.includes('‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£‡∏ô‡∏µ‡πâ') || lowerMessage.includes('‡∏Ñ‡∏∏‡πâ‡∏°‡πÑ‡∏´‡∏°')) {
    intent = 'project-analysis';
    response = `‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£‡πÅ‡∏•‡πâ‡∏ß:\n\n` +
      `‚úÖ ‡∏Å‡∏≥‡πÑ‡∏£‡∏™‡∏∏‡∏ó‡∏ò‡∏¥: 12%\n` +
      `‚úÖ ‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏™‡∏µ‡πà‡∏¢‡∏á: ‡∏ï‡πà‡∏≥\n` +
      `‚úÖ ‡πÇ‡∏≠‡∏Å‡∏≤‡∏™‡∏ä‡∏ô‡∏∞: 75%\n\n` +
      `üí° ‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥: ‡∏¢‡∏∑‡πà‡∏ô‡∏Ç‡πâ‡∏≠‡πÄ‡∏™‡∏ô‡∏≠`;
  }
  // ‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Å‡∏±‡∏ö‡∏£‡∏≤‡∏Ñ‡∏≤
  else if (lowerMessage.includes('‡∏£‡∏≤‡∏Ñ‡∏≤') || lowerMessage.includes('‡πÄ‡∏™‡∏ô‡∏≠')) {
    intent = 'pricing';
    response = `üí∞ ‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡∏£‡∏≤‡∏Ñ‡∏≤‡πÄ‡∏™‡∏ô‡∏≠:\n\n` +
      `‡∏£‡∏≤‡∏Ñ‡∏≤: 47,500,000 ‡∏ö‡∏≤‡∏ó (‡∏•‡∏î 5%)\n` +
      `‡∏Å‡∏≥‡πÑ‡∏£: 15%\n` +
      `‡πÇ‡∏≠‡∏Å‡∏≤‡∏™‡∏ä‡∏ô‡∏∞: 80%\n\n` +
      `üí° ‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•: ‡∏Ñ‡∏π‡πà‡πÅ‡∏Ç‡πà‡∏á‡∏°‡∏±‡∏Å‡πÄ‡∏™‡∏ô‡∏≠‡∏£‡∏≤‡∏Ñ‡∏≤‡∏™‡∏π‡∏á‡∏Å‡∏ß‡πà‡∏≤ 10%`;
  }
  // ‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Å‡∏±‡∏ö‡∏ß‡∏±‡∏™‡∏î‡∏∏
  else if (lowerMessage.includes('‡∏ß‡∏±‡∏™‡∏î‡∏∏') || lowerMessage.includes('‡∏ï‡πâ‡∏ô‡∏ó‡∏∏‡∏ô')) {
    intent = 'material-cost';
    response = `üì¶ ‡∏ï‡πâ‡∏ô‡∏ó‡∏∏‡∏ô‡∏ß‡∏±‡∏™‡∏î‡∏∏:\n\n` +
      `- ‡∏™‡∏≤‡∏¢‡πÑ‡∏ü: 500,000 ‡∏ö‡∏≤‡∏ó\n` +
      `- ‡∏ó‡πà‡∏≠ PVC: 300,000 ‡∏ö‡∏≤‡∏ó\n` +
      `- ‡πÄ‡∏ï‡πâ‡∏≤‡∏£‡∏±‡∏ö: 200,000 ‡∏ö‡∏≤‡∏ó\n` +
      `‡∏£‡∏ß‡∏°: 1,000,000 ‡∏ö‡∏≤‡∏ó\n\n` +
      `üí° ‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥: ‡∏ã‡∏∑‡πâ‡∏≠‡∏à‡∏≤‡∏Å SCC ‡∏ñ‡∏π‡∏Å‡∏Å‡∏ß‡πà‡∏≤ 15%`;
  }
  // ‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Å‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤
  else if (lowerMessage.includes('‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤') || lowerMessage.includes('‡∏´‡∏≤‡∏á‡∏≤‡∏ô')) {
    intent = 'search';
    response = `üîç ‡∏ß‡∏¥‡∏ò‡∏µ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏á‡∏≤‡∏ô:\n\n` +
      `1. ‡πÑ‡∏õ‡∏ó‡∏µ‡πà‡∏´‡∏ô‡πâ‡∏≤ "‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏á‡∏≤‡∏ô‡∏õ‡∏£‡∏∞‡∏°‡∏π‡∏•"\n` +
      `2. ‡∏û‡∏¥‡∏°‡∏û‡πå‡∏Ñ‡∏≥‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤ ‡πÄ‡∏ä‡πà‡∏ô "‡∏Å‡πà‡∏≠‡∏™‡∏£‡πâ‡∏≤‡∏á"\n` +
      `3. ‡∏Ñ‡∏•‡∏¥‡∏Å "‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤" ‡∏´‡∏£‡∏∑‡∏≠ "‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏à‡∏≤‡∏Å‡∏≠‡∏¥‡∏ô‡πÄ‡∏ó‡∏≠‡∏£‡πå‡πÄ‡∏ô‡πá‡∏ï"\n\n` +
      `üí° Tips: ‡πÉ‡∏ä‡πâ‡∏õ‡∏∏‡πà‡∏°‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ß‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏£‡∏¥‡∏á‡∏à‡∏≤‡∏Å e-GP`;
  }
  // ‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Å‡∏±‡∏ö BOQ
  else if (lowerMessage.includes('boq') || lowerMessage.includes('‡∏ñ‡∏≠‡∏î')) {
    intent = 'boq-analysis';
    response = `üìä ‡∏ß‡∏¥‡∏ò‡∏µ‡∏ñ‡∏≠‡∏î BOQ:\n\n` +
      `1. ‡∏≠‡∏±‡∏û‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏ü‡∏•‡πå BOQ\n` +
      `2. ‡∏£‡∏∞‡∏ö‡∏ö‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥\n` +
      `3. ‡πÑ‡∏î‡πâ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ß‡∏±‡∏™‡∏î‡∏∏-‡πÅ‡∏£‡∏á‡∏á‡∏≤‡∏ô-‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏°‡∏∑‡∏≠\n` +
      `4. ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏ï‡πâ‡∏ô‡∏ó‡∏∏‡∏ô‡∏ó‡∏±‡∏ô‡∏ó‡∏µ\n\n` +
      `üí° ‡∏´‡∏£‡∏∑‡∏≠‡πÉ‡∏ä‡πâ Voice Command: "‡∏ñ‡∏≠‡∏î BOQ"`;
  }
  // ‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ
  else if (lowerMessage.includes('‡∏™‡∏ß‡∏±‡∏™‡∏î‡∏µ') || lowerMessage.includes('hello')) {
    intent = 'greeting';
    response = `üëã ‡∏™‡∏ß‡∏±‡∏™‡∏î‡∏µ‡∏Ñ‡∏£‡∏±‡∏ö! ‡∏ú‡∏°‡∏Ñ‡∏∑‡∏≠ AI Assistant\n\n` +
      `‡∏ú‡∏°‡∏ä‡πà‡∏ß‡∏¢‡∏≠‡∏∞‡πÑ‡∏£‡∏Ñ‡∏∏‡∏ì‡πÑ‡∏î‡πâ‡∏ö‡πâ‡∏≤‡∏á:\n` +
      `üîç ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏á‡∏≤‡∏ô‡∏õ‡∏£‡∏∞‡∏°‡∏π‡∏•\n` +
      `üìä ‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå BOQ/TOR\n` +
      `üí∞ ‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡∏£‡∏≤‡∏Ñ‡∏≤‡πÄ‡∏™‡∏ô‡∏≠\n` +
      `üìÑ ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÉ‡∏ö‡πÄ‡∏™‡∏ô‡∏≠‡∏£‡∏≤‡∏Ñ‡∏≤\n\n` +
      `‡∏•‡∏≠‡∏á‡∏ñ‡∏≤‡∏°‡∏ú‡∏°‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢‡∏Ñ‡∏£‡∏±‡∏ö!`;
  }
  // ‡πÑ‡∏°‡πà‡πÄ‡∏Ç‡πâ‡∏≤‡πÉ‡∏à
  else {
    intent = 'unknown';
    response = `ü§î ‡∏Ç‡∏≠‡πÇ‡∏ó‡∏©‡∏Ñ‡∏£‡∏±‡∏ö ‡∏ú‡∏°‡πÑ‡∏°‡πà‡πÄ‡∏Ç‡πâ‡∏≤‡πÉ‡∏à‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°\n\n` +
      `‡∏•‡∏≠‡∏á‡∏ñ‡∏≤‡∏°‡πÅ‡∏ö‡∏ö‡∏ô‡∏µ‡πâ:\n` +
      `- "‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£‡∏ô‡∏µ‡πâ‡∏Ñ‡∏∏‡πâ‡∏°‡πÑ‡∏´‡∏°?"\n` +
      `- "‡∏Ñ‡∏ß‡∏£‡πÄ‡∏™‡∏ô‡∏≠‡∏£‡∏≤‡∏Ñ‡∏≤‡πÄ‡∏ó‡πà‡∏≤‡πÑ‡∏´‡∏£‡πà?"\n` +
      `- "‡∏ß‡∏¥‡∏ò‡∏µ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏á‡∏≤‡∏ô?"\n` +
      `- "‡∏ß‡∏¥‡∏ò‡∏µ‡∏ñ‡∏≠‡∏î BOQ?"`;
  }

  return {
    id: `msg-${Date.now()}`,
    role: 'assistant',
    content: response,
    timestamp: new Date().toISOString(),
    intent,
  };
}

/**
 * ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Ñ‡∏≥‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥
 */
export function getSuggestions(context: ChatContext): string[] {
  const suggestions = [
    '‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£‡∏ô‡∏µ‡πâ‡∏Ñ‡∏∏‡πâ‡∏°‡πÑ‡∏´‡∏°?',
    '‡∏Ñ‡∏ß‡∏£‡πÄ‡∏™‡∏ô‡∏≠‡∏£‡∏≤‡∏Ñ‡∏≤‡πÄ‡∏ó‡πà‡∏≤‡πÑ‡∏´‡∏£‡πà?',
    '‡∏ß‡∏¥‡∏ò‡∏µ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏á‡∏≤‡∏ô?',
    '‡∏ß‡∏¥‡∏ò‡∏µ‡∏ñ‡∏≠‡∏î BOQ?',
    '‡πÄ‡∏õ‡∏£‡∏µ‡∏¢‡∏ö‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö‡∏£‡∏≤‡∏Ñ‡∏≤‡∏ß‡∏±‡∏™‡∏î‡∏∏',
  ];

  if (context.projectName) {
    suggestions.unshift(`‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£ ${context.projectName}`);
  }

  return suggestions;
}
